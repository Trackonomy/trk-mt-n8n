<script setup lang="ts">
import { computed, useTemplateRef } from 'vue';
import type { DataStoreEntity } from '@/features/dataStore/datastore.types';
import { useI18n } from '@n8n/i18n';
import type { Project } from '@/types/projects.types';
import type { PathItem } from '@n8n/design-system/components/N8nBreadcrumbs/Breadcrumbs.vue';
import { useRouter } from 'vue-router';
import DataStoreActions from '@/features/dataStore/components/DataStoreActions.vue';
import { DATA_STORE_VIEW } from '@/features/dataStore/constants';
import { useDataStoreStore } from '../dataStore.store';
import { useToast } from '@/composables/useToast';

const BREADCRUMBS_SEPARATOR = 'â€º';

type Props = {
	dataStore: DataStoreEntity;
};

const props = defineProps<Props>();

const renameInput = useTemplateRef('renameInput');

const dataStoreStore = useDataStoreStore();

const i18n = useI18n();
const router = useRouter();
const toast = useToast();

const project = computed(() => {
	return props.dataStore.project ?? null;
});

const breadcrumbs = computed<PathItem[]>(() => {
	if (!project.value) {
		return [];
	}
	return [
		{
			id: 'datastores',
			label: i18n.baseText('dataStore.dataStores'),
			href: `/projects/${project.value.id}/datastores`,
		},
	];
});

const onItemClicked = async (item: PathItem) => {
	if (item.href) {
		await router.push(item.href);
	}
};

const onDelete = async () => {
	await router.push({ name: DATA_STORE_VIEW, params: { projectId: props.dataStore.projectId } });
};

const onRename = () => {
	// Focus rename input if the action is rename
	// We need this timeout to ensure action toggle is closed before focusing
	if (renameInput.value?.forceFocus) {
		setTimeout(() => {
			renameInput.value?.forceFocus();
		}, 100);
	}
};

const onNameSubmit = async (name: string) => {
	try {
		const updated = await dataStoreStore.updateDataStore(
			props.dataStore.id,
			name,
			props.dataStore.projectId,
		);
		if (!updated) {
			toast.showError(
				new Error(i18n.baseText('generic.unknownError')),
				i18n.baseText('dataStore.rename.error'),
			);
		}
	} catch (error) {
		toast.showError(error, i18n.baseText('dataStore.rename.error'));
	}
};
</script>

<template>
	<div :class="$style['data-store-breadcrumbs']">
		<n8n-breadcrumbs
			:items="breadcrumbs"
			:separator="BREADCRUMBS_SEPARATOR"
			@item-selected="onItemClicked"
		>
			<template #prepend>
				<!-- TODO: Get rid of this type cast -->
				<project-breadcrumb :current-project="project as Project" />
			</template>
			<template #append>
				<span :class="$style.separator">{{ BREADCRUMBS_SEPARATOR }}</span>
				<N8nInlineTextEdit
					ref="renameInput"
					data-test-id="datastore-header-name-input"
					:placeholder="i18n.baseText('dataStore.add.input.name.label')"
					:class="$style['breadcrumb-current']"
					:model-value="props.dataStore.name"
					:max-length="30"
					:read-only="false"
					:disabled="false"
					@update:model-value="onNameSubmit"
				/>
			</template>
		</n8n-breadcrumbs>
		<div :class="$style['data-store-actions']">
			<DataStoreActions :data-store="props.dataStore" @rename="onRename" @on-deleted="onDelete" />
		</div>
	</div>
</template>

<style lang="scss" module>
.data-store-breadcrumbs {
	display: flex;
	align-items: end;
}

/* TODO: Align better */
.data-store-actions {
	position: relative;
	bottom: var(--spacing-5xs);
}

.separator {
	font-size: var(--font-size-xl);
	color: var(--color-foreground-base);
	padding: var(--spacing-3xs) var(--spacing-4xs) var(--spacing-4xs);
}

.breadcrumb-current {
	color: $custom-font-dark;
	font-size: var(--font-size-s);
	padding: var(--spacing-3xs) var(--spacing-4xs) var(--spacing-4xs);
}
</style>
